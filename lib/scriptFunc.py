# -*- coding=utf-8 -*-
import os
import prettytable
import importlib
import shutil

from data.config.config import SYSPATH
from common.outputHelp import print_error, print_info, print_success, print_warn


def loadScripts(url, cms, script):
    try:
        script = importlib.import_module('scripts.' + cms + "." + script.split(".")[0])
        script.exp(url)
    except ImportError as e:
        print_warn("[!] Import script error.Please make sure the script name and type name are right!\n")
        exit()

def listScripts(dirs):
    table = prettytable.PrettyTable()
    table.field_names = ["ID", "cms Name", "script Name"]
    num = 1
    for dirname in dirs:
        path = SYSPATH + "\\scripts\\" + dirname
        if not os.path.isdir(path) or dirname == "__pycache__":
            continue
        scripts = os.listdir(path)
        row = []
        row.append(num)
        row.append(dirname)
        result = ""
        for script in scripts:
            scriptPath = SYSPATH + "\\scripts\\" + dirname + "\\" + script
            if os.path.isdir(scriptPath) or script == "__init__.py":
                continue
            result += script + "\n"
        row.append(result)
        table.add_row(row)
        num += 1
    print_success(table)

def showScripts(cms, script):
    path = SYSPATH + "\\scripts" + "\\" + cms + "\\" + script
    with open(path) as f:
        content = f.read()
    
    print_success("[+] The " + cms + "'s " + script + ":\n")
    print(content)

def addScripts(cms, script):
    path = SYSPATH + "\\scripts\\" + cms
    if not os.path.isdir(path):
        print_warn("[!] {0} is not exists.".format(path))
        os.mkdir(path)
    if not os.path.isfile(script):
        print_error("[-] {0} is not exists.".format(script))
    else:
        try:
            shutil.copy(script, path)
            print_success("[+] Add script success.")
        except:
            print_error("[-] Copy file failed.")
